<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations | Godoy Martins</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vanilla-calendar@1.4/build/vanilla-calendar.min.css" rel="stylesheet">
    <style>
        .reservation-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-confirmed {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-canceled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-completed {
            background-color: #e0e7ff;
            color: #3730a3;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex">
        <!-- Sidebar -->
        <div class="bg-blue-800 text-white w-64 min-h-screen p-4">
            <div class="mb-8 text-center">
                <img src="images/logo.png" alt="Logo" class="h-12 mx-auto">
            </div>
            <nav>
                <ul class="space-y-2">
                    <li><a href="dashboard.html" class="block py-2 px-4 rounded hover:bg-blue-700"><i class="fas fa-tachometer-alt mr-2"></i> Dashboard</a></li>
                    <li><a href="fleet.html" class="block py-2 px-4 rounded hover:bg-blue-700"><i class="fas fa-car mr-2"></i> Fleet</a></li>
                    <li><a href="customers.html" class="block py-2 px-4 rounded hover:bg-blue-700"><i class="fas fa-users mr-2"></i> Customers</a></li>
                    <li><a href="reservations.html" class="block py-2 px-4 rounded bg-blue-700"><i class="fas fa-calendar-alt mr-2"></i> Reservations</a></li>
                    <li><a href="finances.html" class="block py-2 px-4 rounded hover:bg-blue-700"><i class="fas fa-chart-line mr-2"></i> Finances</a></li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Reservation Management</h1>
                <button id="newReservationBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i> New Reservation
                </button>
            </div>

            <!-- Reservation Form -->
            <div id="reservationFormContainer" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h2 class="text-xl font-semibold mb-4" id="reservationFormTitle">New Reservation</h2>
                <form id="reservationForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Customer</label>
                            <select id="customerSelect" class="w-full p-2 border rounded" required>
                                <option value="">Select Customer</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Vehicle</label>
                            <select id="vehicleSelect" class="w-full p-2 border rounded" required>
                                <option value="">Select Vehicle</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Pickup Date</label>
                            <input type="date" id="pickupDate" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Return Date</label>
                            <input type="date" id="returnDate" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Daily Rate ($)</label>
                            <input type="number" id="dailyRate" step="0.01" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Total Amount ($)</label>
                            <input type="number" id="totalAmount" class="w-full p-2 border rounded bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Status</label>
                            <select id="reservationStatus" class="w-full p-2 border rounded" required>
                                <option value="confirmed">Confirmed</option>
                                <option value="pending">Pending</option>
                                <option value="canceled">Canceled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-2">Notes</label>
                            <textarea id="reservationNotes" rows="3" class="w-full p-2 border rounded"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" id="cancelReservationBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">Cancel</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Save Reservation</button>
                    </div>
                    <input type="hidden" id="reservationId" value="">
                </form>
            </div>

            <!-- Calendar View -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div id="calendar" class="vanilla-calendar"></div>
            </div>

            <!-- Reservations Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div>
                            <label class="block text-gray-700 mb-1 text-sm">Filter by Status:</label>
                            <select id="statusFilter" class="p-2 border rounded">
                                <option value="all">All Reservations</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="pending">Pending</option>
                                <option value="canceled">Canceled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 text-sm">Filter by Date:</label>
                            <input type="date" id="dateFilter" class="p-2 border rounded">
                        </div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Total: <span id="totalReservations">0</span> reservations</span>
                    </div>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reservation ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="reservationsTableBody">
                        <!-- Reservations will be added here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar@1.4/build/vanilla-calendar.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Database simulation
            let reservations = JSON.parse(localStorage.getItem('reservations')) || [];
            let customers = JSON.parse(localStorage.getItem('customers')) || [];
            let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];
            let currentEditId = null;
    
            // DOM Elements
            const formContainer = document.getElementById('reservationFormContainer');
            const reservationForm = document.getElementById('reservationForm');
            const newReservationBtn = document.getElementById('newReservationBtn');
            const cancelReservationBtn = document.getElementById('cancelReservationBtn');
            const reservationsTableBody = document.getElementById('reservationsTableBody');
            const totalReservationsSpan = document.getElementById('totalReservations');
            const statusFilter = document.getElementById('statusFilter');
            const dateFilter = document.getElementById('dateFilter');
    
            // Calendar initialization
            const calendar = new VanillaCalendar('#calendar', {
                settings: {
                    selected: {
                        dates: getReservedDates(),
                        highlight: {
                            backgroundColor: '#f87171',
                            color: '#fff'
                        }
                    },
                    visibility: {
                        weekend: true,
                    }
                },
                actions: {
                    clickDay(event, dates) {
                        dateFilter.value = dates[0];
                        filterReservations();
                    }
                }
            });
            calendar.init();
    
            // Event Listeners
            newReservationBtn.addEventListener('click', showAddForm);
            cancelReservationBtn.addEventListener('click', hideForm);
            reservationForm.addEventListener('submit', handleFormSubmit);
            statusFilter.addEventListener('change', filterReservations);
            dateFilter.addEventListener('change', filterReservations);
            
            document.getElementById('pickupDate').addEventListener('change', calculateTotal);
            document.getElementById('returnDate').addEventListener('change', calculateTotal);
            document.getElementById('dailyRate').addEventListener('input', calculateTotal);
            document.getElementById('vehicleSelect').addEventListener('change', updateDailyRate);
    
            // Initialize
            populateCustomerSelect();
            populateVehicleSelect();
            renderReservations();
            setDefaultDates();
    
            // Functions
            function showAddForm() {
                currentEditId = null;
                document.getElementById('reservationFormTitle').textContent = 'New Reservation';
                document.getElementById('reservationId').value = '';
                reservationForm.reset();
                setDefaultDates();
                formContainer.classList.remove('hidden');
            }
    
            function hideForm() {
                formContainer.classList.add('hidden');
            }
    
            function setDefaultDates() {
                const today = new Date().toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                document.getElementById('pickupDate').value = today;
                document.getElementById('returnDate').value = tomorrowStr;
                calculateTotal();
            }
    
            function populateCustomerSelect() {
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">Select Customer</option>';
                
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.fullName} (${customer.phone})`;
                    select.appendChild(option);
                });
            }
    
            function populateVehicleSelect() {
                const select = document.getElementById('vehicleSelect');
                select.innerHTML = '<option value="">Select Vehicle</option>';
                
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.id;
                    option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.plate})`;
                    option.dataset.dailyRate = vehicle.dailyRate;
                    select.appendChild(option);
                });
            }
    
            function updateDailyRate() {
                const vehicleSelect = document.getElementById('vehicleSelect');
                const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                
                if (selectedOption && selectedOption.dataset.dailyRate) {
                    document.getElementById('dailyRate').value = selectedOption.dataset.dailyRate;
                    calculateTotal();
                }
            }
    
            function calculateTotal() {
                const pickupDate = new Date(document.getElementById('pickupDate').value);
                const returnDate = new Date(document.getElementById('returnDate').value);
                const dailyRate = parseFloat(document.getElementById('dailyRate').value) || 0;
                
                if (pickupDate && returnDate && !isNaN(dailyRate)) {
                    const diffTime = Math.abs(returnDate - pickupDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
                    const totalAmount = diffDays * dailyRate;
                    document.getElementById('totalAmount').value = totalAmount.toFixed(2);
                }
            }
    
            function getReservedDates() {
                const reservedDates = [];
                reservations.forEach(reservation => {
                    if (reservation.status !== 'canceled') {
                        const start = new Date(reservation.pickupDate);
                        const end = new Date(reservation.returnDate);
                        
                        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                            reservedDates.push(d.toISOString().split('T')[0]);
                        }
                    }
                });
                return reservedDates;
            }
    
            function handleFormSubmit(e) {
                e.preventDefault();
                
                const customerId = document.getElementById('customerSelect').value;
                const vehicleId = document.getElementById('vehicleSelect').value;
                const customer = customers.find(c => c.id === customerId);
                const vehicle = vehicles.find(v => v.id === vehicleId);
                
                const formData = {
                    id: currentEditId || Date.now().toString(),
                    customerId,
                    vehicleId,
                    customerName: customer ? customer.fullName : '',
                    vehicleInfo: vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.plate})` : '',
                    pickupDate: document.getElementById('pickupDate').value,
                    returnDate: document.getElementById('returnDate').value,
                    dailyRate: parseFloat(document.getElementById('dailyRate').value),
                    totalAmount: parseFloat(document.getElementById('totalAmount').value),
                    status: document.getElementById('reservationStatus').value,
                    notes: document.getElementById('reservationNotes').value,
                    createdAt: new Date().toISOString()
                };
    
                if (currentEditId) {
                    // Update existing reservation
                    const index = reservations.findIndex(r => r.id === currentEditId);
                    reservations[index] = formData;
                } else {
                    // Add new reservation
                    reservations.push(formData);
                }
    
                localStorage.setItem('reservations', JSON.stringify(reservations));
                renderReservations();
                updateCalendar();
                hideForm();
            }
    
            function renderReservations(reservationsList = reservations) {
                reservationsTableBody.innerHTML = '';
                totalReservationsSpan.textContent = reservationsList.length;
                
                reservationsList.forEach(reservation => {
                    const row = document.createElement('tr');
                    
                    // Format dates
                    const pickupDate = new Date(reservation.pickupDate).toLocaleDateString();
                    const returnDate = new Date(reservation.returnDate).toLocaleDateString();
                    const days = Math.ceil((new Date(reservation.returnDate) - new Date(reservation.pickupDate)) / (1000 * 60 * 60 * 24)) || 1;
                    
                    // Status badge
                    let statusClass = '';
                    let statusText = '';
                    switch(reservation.status) {
                        case 'confirmed':
                            statusClass = 'status-confirmed';
                            statusText = 'Confirmed';
                            break;
                        case 'pending':
                            statusClass = 'status-pending';
                            statusText = 'Pending';
                            break;
                        case 'canceled':
                            statusClass = 'status-canceled';
                            statusText = 'Canceled';
                            break;
                        case 'completed':
                            statusClass = 'status-completed';
                            statusText = 'Completed';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${reservation.id.slice(-6)}</div>
                            <div class="text-sm text-gray-500">${new Date(reservation.createdAt).toLocaleDateString()}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${reservation.customerName}</div>
                            <div class="text-sm text-gray-500">${reservation.customerId.slice(-6)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${reservation.vehicleInfo}</div>
                            <div class="text-sm text-gray-500">${reservation.vehicleId.slice(-6)}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${pickupDate} to ${returnDate}</div>
                            <div class="text-sm text-gray-500">${days} days</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">$${reservation.totalAmount.toFixed(2)}</div>
                            <div class="text-sm text-gray-500">$${reservation.dailyRate.toFixed(2)}/day</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="reservation-status ${statusClass}">${statusText}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editReservation('${reservation.id}')" class="text-blue-600 hover:text-blue-900 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteReservation('${reservation.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    reservationsTableBody.appendChild(row);
                });
            }
    
            function filterReservations() {
                const status = statusFilter.value;
                const date = dateFilter.value;
                
                let filtered = reservations;
                
                if (status !== 'all') {
                    filtered = filtered.filter(r => r.status === status);
                }
                
                if (date) {
                    filtered = filtered.filter(r => {
                        const pickup = new Date(r.pickupDate).toISOString().split('T')[0];
                        const ret = new Date(r.returnDate).toISOString().split('T')[0];
                        return date >= pickup && date <= ret;
                    });
                }
                
                renderReservations(filtered);
            }
    
            function updateCalendar() {
                calendar.update({
                    selected: {
                        dates: getReservedDates()
                    }
                });
            }
    
            function editReservation(id) {
                const reservation = reservations.find(r => r.id === id);
                if (reservation) {
                    currentEditId = id;
                    document.getElementById('reservationFormTitle').textContent = 'Edit Reservation';
                    document.getElementById('reservationId').value = id;
                    
                    // Set form values
                    document.getElementById('customerSelect').value = reservation.customerId;
                    document.getElementById('vehicleSelect').value = reservation.vehicleId;
                    document.getElementById('pickupDate').value = reservation.pickupDate;
                    document.getElementById('returnDate').value = reservation.returnDate;
                    document.getElementById('dailyRate').value = reservation.dailyRate;
                    document.getElementById('totalAmount').value = reservation.totalAmount;
                    document.getElementById('reservationStatus').value = reservation.status;
                    document.getElementById('reservationNotes').value = reservation.notes || '';
                    
                    formContainer.classList.remove('hidden');
                }
            }
    
            function deleteReservation(id) {
                if (confirm('Are you sure you want to delete this reservation?')) {
                    reservations = reservations.filter(r => r.id !== id);
                    localStorage.setItem('reservations', JSON.stringify(reservations));
                    renderReservations();
                    updateCalendar();
                }
            }
    
            // Make functions available globally
            window.editReservation = editReservation;
            window.deleteReservation = deleteReservation;
            window.showAddForm = showAddForm;
            window.hideForm = hideForm;
        });
    </script>